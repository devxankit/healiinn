const asyncHandler = require('../../middleware/asyncHandler');
const SupportTicket = require('../../models/SupportTicket');

// Helper functions
const buildPagination = (req) => {
  const page = Math.max(parseInt(req.query.page, 10) || 1, 1);
  const limit = Math.min(Math.max(parseInt(req.query.limit, 10) || 20, 1), 100);
  const skip = (page - 1) * limit;
  return { page, limit, skip };
};

// POST /api/doctors/support
exports.createSupportTicket = asyncHandler(async (req, res) => {
  const { id } = req.auth;
  const { subject, message, priority } = req.body;

  if (!subject || !message) {
    return res.status(400).json({
      success: false,
      message: 'Subject and message are required',
    });
  }

  const ticket = await SupportTicket.create({
    userId: id,
    userType: 'doctor',
    subject,
    message,
    priority: priority || 'medium',
    status: 'open',
  });

  // Emit real-time event to admins
  try {
    const { getIO } = require('../../config/socket');
    const io = getIO();
    io.to('admins').emit('support:ticket:created', {
      ticket: await SupportTicket.findById(ticket._id)
        .populate('userId', 'firstName lastName email phone'),
    });
  } catch (error) {
    console.error('Socket.IO error:', error);
  }

  return res.status(201).json({
    success: true,
    message: 'Support ticket created successfully',
    data: ticket,
  });
});

// GET /api/doctors/support
exports.getSupportTickets = asyncHandler(async (req, res) => {
  const { id } = req.auth;
  const { status, priority } = req.query;
  const { page, limit, skip } = buildPagination(req);

  const filter = { userId: id, userType: 'doctor' };
  if (status) filter.status = status;
  if (priority) filter.priority = priority;

  const [tickets, total] = await Promise.all([
    SupportTicket.find(filter)
      .sort({ createdAt: -1 })
      .skip(skip)
      .limit(limit),
    SupportTicket.countDocuments(filter),
  ]);

  return res.status(200).json({
    success: true,
    data: {
      items: tickets,
      pagination: {
        page,
        limit,
        total,
        totalPages: Math.ceil(total / limit) || 1,
      },
    },
  });
});

// GET /api/doctors/support/history
exports.getSupportHistory = asyncHandler(async (req, res) => {
  const { id } = req.auth;

  const tickets = await SupportTicket.find({
    userId: id,
    userType: 'doctor',
    status: { $in: ['resolved', 'closed'] },
  })
    .sort({ createdAt: -1 })
    .limit(20);

  return res.status(200).json({
    success: true,
    data: tickets,
  });
});

